name: CodeQL (swift)

permissions:
  contents: read
  security-events: write

on:
  schedule:
    - cron: '0 4 * * 1'
  workflow_dispatch:

jobs:
  analyze:
    name: Analyze (swift)
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up Gradle
      uses: gradle/actions/setup-gradle@v4

    - name: Cache SPM packages
      uses: actions/cache@v4
      with:
        path: iosApp/spm-derived-data/SourcePackages
        key: ${{ runner.os }}-spm-${{ hashFiles('iosApp/Where.xcodeproj/project.xcworkspace/xcshareddata/swiftpm/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-

    - name: Cache Konan
      uses: actions/cache@v4
      with:
        path: |
          /Users/runner/.konan/kotlin-native-prebuilt-*
          /Users/runner/.konan/dependencies
        key: ${{ runner.os }}-konan-${{ hashFiles('gradle/libs.versions.toml') }}
        restore-keys: |
          ${{ runner.os }}-konan-

    - name: Create local.properties
      run: |
        echo "sdk.dir=$ANDROID_HOME" > local.properties
        echo "TRACKING_HMAC_SECRET=codeql-dummy-hmac-secret" >> local.properties

    - name: Create GoogleService-Info.plist
      run: |
        cp .github/dummy/GoogleService-Info-dummy.plist iosApp/Where/GoogleService-Info.plist
        cp .github/dummy/GoogleService-debug-Info-dummy.plist iosApp/Where/GoogleService-debug-Info.plist

    - name: Create Generated.xcconfig
      run: |
        echo "CURRENT_PROJECT_VERSION = 1" > iosApp/Where/Generated.xcconfig
        echo "MARKETING_VERSION = 1.0.1" >> iosApp/Where/Generated.xcconfig

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v4
      with:
        languages: swift
        build-mode: manual

    - name: Resolve SPM packages
      run: |
        xcodebuild -resolvePackageDependencies \
          -project iosApp/Where.xcodeproj \
          -scheme Where \
          -derivedDataPath iosApp/spm-derived-data

    - name: Fix nanopb build file conflict
      run: rm -f iosApp/spm-derived-data/SourcePackages/checkouts/nanopb/build

    - name: Build
      run: |
        xcodebuild build \
          -project iosApp/Where.xcodeproj \
          -scheme Where \
          -sdk iphonesimulator \
          -derivedDataPath iosApp/spm-derived-data \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v4
      with:
        category: /language:swift
