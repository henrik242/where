name: Deploy Server

on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-server.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: |
        cd server
        bun install

    - name: Build client TypeScript
      run: |
        cd server
        bun run build

    - name: Run unit tests
      run: |
        cd server
        npm run test:unit

    - name: Deploy to server
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        SOURCE: "server/"
        TARGET: ${{ secrets.REMOTE_TARGET }}
        EXCLUDE: "/node_modules/, /bun.lockb, /.env, *.log, *.pid"

    - name: Deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Deployment successful!"
          echo "Server is running at https://where.synth.no"
          echo "Files copied to ${{ secrets.REMOTE_TARGET }}"
          echo ""
          echo "⚠️  REMINDER: Ensure TRACKING_HMAC_SECRET is set in the server's .env file!"
          echo "The server will reject all tracking requests without a valid HMAC secret."
        else
          echo "❌ Deployment failed!"
          exit 1
        fi

