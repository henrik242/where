name: Deploy Server

on:
  push:
    branches: [ main ]
    paths:
      - 'web/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: |
        cd web
        bun install

    - name: Generate version info
      run: |
        cd web
        GIT_COMMIT_COUNT=$(git rev-list --count HEAD)
        GIT_SHORT_SHA=$(git rev-parse --short HEAD)
        BUILD_DATE=$(date +%Y-%m-%d)
        VERSION_STRING="${GIT_COMMIT_COUNT}.${GIT_SHORT_SHA} ${BUILD_DATE}"
        echo "VERSION_STRING=$VERSION_STRING" >> $GITHUB_ENV
        echo "Generated version: $VERSION_STRING"

    - name: Build client TypeScript
      run: |
        cd web
        bun run build

    - name: Inject version into HTML
      run: |
        cd web
        sed -i "s|<!-- VERSION_PLACEHOLDER -->|<div id=\"version-info\" style=\"display:none;\">${VERSION_STRING}</div>|g" src/public/index.html

    - name: Run unit tests
      run: |
        cd web
        bun run test:unit

    - name: Deploy to web
      uses: easingthemes/ssh-deploy@main
      with:
        SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
        REMOTE_USER: ${{ secrets.REMOTE_USER }}
        SOURCE: "web/"
        TARGET: ${{ secrets.REMOTE_TARGET }}
        EXCLUDE: "/node_modules/, /bun.lockb, /.env, *.log, *.pid"

    - name: Deployment status
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "✅ Deployment successful!"
          echo "Server is running at https://where.synth.no"
          echo "Files copied to ${{ secrets.REMOTE_TARGET }}"
          echo ""
          echo "⚠️  REMINDER: Ensure TRACKING_HMAC_SECRET is set in the server's .env file!"
          echo "The server will reject all tracking requests without a valid HMAC secret."
        else
          echo "❌ Deployment failed!"
          exit 1
        fi

